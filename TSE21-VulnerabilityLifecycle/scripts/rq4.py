import pandas as pd


input_file_path = "../data/rq4_input.csv"
top_10_cwe = "../data/top10cwe.csv"

df_merged = pd.read_csv(input_file_path, delimiter=",")

# Profiling and Descriptive stats
num_repos = df_merged["repo"].nunique()
num_cwes = df_merged["cwe"].nunique()
df_merged_summary = df_merged.describe()
print("Repos: {}".format(num_repos))
print("CWEs: {}".format(num_cwes))
print("Summary of CVEs with Removal Information")
print(round(df_merged_summary, 2))
print()

# Group CVEs by fix_category and get the most frequent group
categories_groups = df_merged.groupby("fix_category", sort=False)
num_categories = len(categories_groups)

categories_occurances = categories_groups.size()
categories_occurances.sort_values(inplace=True, ascending=False)
print(categories_occurances)
print("Fix Categories: {}".format(num_categories))
print("Most Frequent Fix Category: {} with {} Occurences".format(categories_occurances.index[0], categories_occurances[0]))
print()

# compute the percentage of fix categories of top-10 CWE 
top_10_cwe = pd.read_csv(top_10_cwe)["cwe"].to_list()
df_top_10 = pd.DataFrame()
for cwe in top_10_cwe:
    df_cwe = df_merged[df_merged["cwe"] == cwe]
    df_top_10 = df_top_10.append(df_cwe)
top_10_cwe_groups = df_top_10.groupby("cwe", sort=False)
categories_freq = top_10_cwe_groups["fix_category"].value_counts()
categories_total = top_10_cwe_groups["fix_category"].count()
categories_freq_total = pd.merge(categories_freq, categories_total, left_index=True, right_index=True)
categories_freq_total.rename({
    "fix_category_x": "count",
    "fix_category_y": "total"
}, axis=1, inplace=True)
categories_freq_total["perc"] = categories_freq_total["count"] / categories_freq_total["total"] * 100
print("Fix Categories on Top-10 CWE")
print(round(categories_freq_total, 2))
